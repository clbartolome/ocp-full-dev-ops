---
- name: Main
  hosts: localhost
  gather_facts: false
  vars:
    list: []

  pre_tasks:
    - name: Include configuration vars
      ansible.builtin.include_vars:
        file: vars/ansible-config.yaml

  tasks:

    - name: Get OCP cluster information
      ansible.builtin.include_tasks:
        file: playbooks/ocp-cluster-info.yml

    - name: Config OCP cluster
      ansible.builtin.include_tasks: 
        file: playbooks/ocp-cluster-config.yml

    - name: Install Gitea instance
      ansible.builtin.include_tasks:
        file: playbooks/ocp-gitea-deploy.yml

    - name: Config Gitea instance
      ansible.builtin.include_tasks:
        file: playbooks/ocp-gitea-config.yml

    - name: Create and clone remote repositories in Gitea
      include_tasks: playbooks/gitea-external-repos.yml
      loop: "{{ demo_external_repositories }}"

    - name: Create and push components repositories in Gitea
      include_tasks: playbooks/gitea-components-repos.yml
      loop: '{{ demo_components }}'
      loop_control:
        loop_var: demo_component

    - name: Deploy and configure OpenShift GitOps 
      ansible.builtin.include_tasks:
        file: playbooks/ocp-gitops-deploy.yml

    - name: Deploy components
      include_tasks: playbooks/ocp-components-deploy.yml
      loop: "{{ demo_components }}"

